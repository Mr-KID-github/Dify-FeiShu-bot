![å¦‚ä½•å‘é€æ¶ˆæ¯å¡ç‰‡](../static/images/å¦‚ä½•å‘é€æ¶ˆæ¯å¡ç‰‡.png)

# å»ºç«‹æ¶ˆæ¯å¡ç‰‡
å…ˆåœ¨é£ä¹¦å¼€æ”¾å¹³å°ä¸Šæ–°å»ºè‡ªå®šä¹‰æ¶ˆæ¯å¡ç‰‡ğŸ’³
åœ°å€å¦‚ä¸‹ï¼šhttps://open.feishu.cn/cardkit

æ¶ˆæ¯å¡ç‰‡çš„å»ºç«‹å¦‚å›¾æ‰€ç¤ºï¼š
![æ¶ˆæ¯å¡ç‰‡é…ç½®](../static/images/æ¶ˆæ¯å¡ç‰‡å»ºç«‹.jpeg)

ä½ éœ€è¦è®°ä½æ¶ˆæ¯å¡ç‰‡çš„IDï¼Œä»¥å¢¨è¶£ä¹¦æ³•çš„æ¶ˆæ¯å¡ç‰‡ä¸ºä¾‹ï¼Œè¿™ä¸ªIDæ˜¯ï¼š`AAqHg8SNnefQz`

ä½ å¯ä»¥ä½¿ç”¨æ‹–æ‹½ç»„ä»¶çš„æ–¹å¼æ¥å»ºç«‹æ¶ˆæ¯å¡ç‰‡ï¼Œéå¸¸æ–¹ä¾¿

# å¦‚ä½•æ‰“é€šæ¶ˆæ¯å¡ç‰‡å’ŒDifyå›è°ƒçš„å›ç­”
æœ‰å¾ˆå¤šæœ‹å‹å®ç°è¿™ä¸ªæ•ˆæœï¼Œå°±æ˜¯å°†Difyçš„å›ç­”é€šè¿‡æ¶ˆæ¯å¡ç‰‡çš„å½¢å¼å±•ç°ç»™ç”¨æˆ·ï¼Œå› ä¸ºæ¶ˆæ¯å¡ç‰‡æ ·å¼è‡ªå®šä¹‰å¯ä»¥åšçš„å¾ˆç¾è§‚ï¼Œä½†æ˜¯å†…å®¹æ–¹é¢å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ
è¿™é‡Œé£ä¹¦å…¶å®åšçš„å¾ˆå¥½ï¼é£ä¹¦åœ¨æ¶ˆæ¯å¡ç‰‡ä¸­å¯ä»¥è®¾ç½®å˜é‡ï¼Œæ‰€ä»¥ä½ åœ¨è°ƒç”¨æ¶ˆæ¯å¡ç‰‡çš„æ—¶å€™ï¼Œå¯ä»¥ç»™å…¶ä¼ å…¥å˜é‡ï¼Œå®ç°å¡ç‰‡å†…å®¹çš„èµ‹äºˆã€‚
å…·ä½“æ–‡æ¡£ğŸ“„å¦‚ä¸‹ï¼š
[å‘é€æ¶ˆæ¯å¡ç‰‡å®˜æ–¹æ–‡æ¡£ğŸ“„](https://open.feishu.cn/document/ukTMukTMukTM/uYzM3QjL2MzN04iNzcDN/send-message-card/send-message-using-card-id)

ç®€å•æ¥è¯´ï¼Œæ¶ˆæ¯å¡ç‰‡çš„å‘é€ä½ éœ€è¦è®¾ç½®ä¸‰ä¸ªå±æ€§ï¼š
å¡ç‰‡IDã€å¡ç‰‡åã€å¡ç‰‡å˜é‡

å‚è€ƒå¦‚ä¸‹ï¼š
```bash
FEISHU_CARD_TEMPLATES = '{
    "waiting_message_card": {                   # æ¶ˆæ¯å¡ç‰‡æ¨¡æ¿
        "template_id": "AAqHgvQHmb0Yp",         # æ¨¡æ¿ID
        "template_variable": {                  # æ¨¡æ¿å˜é‡

        }         
    },
    "reply_message_card": {                     # æ¶ˆæ¯å¡ç‰‡æ¨¡æ¿
        "template_id": "AAqHgxHLPqnHd",         # æ¨¡æ¿ID
        "template_variable": {                  # æ¨¡æ¿å˜é‡
            "answer": "", 
            "nextQ_A": "",
            "nextQ_B": "",
            "nextQ_C": "",
        }                 
    },
    "first_meeting_card": {                     # æ¶ˆæ¯å¡ç‰‡æ¨¡æ¿
        "template_id": "AAqHg8SNnefQz",         # æ¨¡æ¿ID
        "template_variable": {}                 # æ¨¡æ¿å˜é‡
    },
}'
```
# å¦‚ä½•ä½¿ç”¨æ¶ˆæ¯å¡ç‰‡
æ¥ä¸‹æ¥æˆ‘å°†ä¼šä»‹ç»å¦‚ä½•ä½¿ç”¨å°è£…å¥½çš„é£ä¹¦æ¶ˆæ¯å¡ç‰‡APIï¼Œé€šè¿‡è°ƒç”¨`FeishuAPI`ç±»çš„`send_message`å’Œ`update_message`æ–¹æ³•æ¥å‘é€å’Œæ›´æ–°æ¶ˆæ¯å¡ç‰‡ã€‚

### å‘é€æ¶ˆæ¯å¡ç‰‡
é€šè¿‡è°ƒç”¨`send_message`æ–¹æ³•å¯ä»¥å‘é€æ¶ˆæ¯å¡ç‰‡ã€‚ä»¥ä¸‹æ˜¯æ–¹æ³•çš„è¯¦ç»†è¯´æ˜ï¼š

**æ–¹æ³•ç­¾å**
```python
def send_message(self, receive_id_type, receive_id, content=None, card_template_name=None, template_variables=None):
```
**å‚æ•°è¯´æ˜**
- receive_id_typeï¼šæ¥æ”¶IDç±»å‹ï¼Œå¯ä»¥æ˜¯chat_idã€open_idæˆ–user_idã€‚
- receive_idï¼šæ¥æ”¶IDã€‚
- contentï¼šæ¶ˆæ¯å†…å®¹ï¼ˆå½“æœªä½¿ç”¨æ¨¡æ¿æ—¶ï¼‰ã€‚
- card_template_nameï¼šå¡ç‰‡æ¨¡æ¿åç§°ï¼ˆå¯é€‰ï¼‰ã€‚
- template_variablesï¼šæ¨¡æ¿å˜é‡ï¼ˆå¯é€‰ï¼‰ã€‚
**ç¤ºä¾‹ä»£ç **
```python
message_response = feishu_api.send_message(
    receive_id_type='chat_id',
    receive_id='oc_1234567890',
    content='Hello, this is a test message.',
    card_template_name='example_template',
    template_variables={'username': 'Alice'}
)
```
### æ›´æ–°æ¶ˆæ¯å¡ç‰‡
é€šè¿‡è°ƒç”¨`update_message`æ–¹æ³•å¯ä»¥æ›´æ–°å·²å‘é€çš„æ¶ˆæ¯å¡ç‰‡ã€‚ä»¥ä¸‹æ˜¯æ–¹æ³•çš„è¯¦ç»†è¯´æ˜ï¼š

**æ–¹æ³•ç­¾å**
```python
def update_message(self, message_id, content=None, card_template_name=None, template_variables=None):
```

**å‚æ•°è¯´æ˜**
- message_idï¼šæ¶ˆæ¯IDã€‚
- contentï¼šæ–°æ¶ˆæ¯å†…å®¹ï¼ˆå½“æœªä½¿ç”¨æ¨¡æ¿æ—¶ï¼‰ã€‚
- card_template_nameï¼šå¡ç‰‡æ¨¡æ¿åç§°ï¼ˆå¯é€‰ï¼‰ã€‚
- template_variablesï¼šæ¨¡æ¿å˜é‡ï¼ˆå¯é€‰ï¼‰ã€‚

**ç¤ºä¾‹ä»£ç **
```python
update_response = feishu_api.update_message(
    message_id='om_9876543210',
    content='This is the updated message content.',
    card_template_name='example_template',
    template_variables={'username': 'Bob'}
)
```
**å®Œæ•´ä»£ç ç¤ºä¾‹**

ä»¥ä¸‹æ˜¯å®Œæ•´çš„ä»£ç ç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨`send_message`å’Œ`update_message`æ–¹æ³•ï¼š

```python
import requests
import json
import logging

logger = logging.getLogger(__name__)

class FeishuAPI:
    FEISHU_CARD_TEMPLATES = {
        'example_template': {
            'template_id': 'tpl_123456',
            'template_variable': {
                'username': 'default_user'
            }
        }
    }

    def get_access_token(self):
        url = "https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal/"
        headers = {
            'Content-Type': 'application/json; charset=utf-8'
        }
        payload = {
            "app_id": "<your_app_id>",
            "app_secret": "<your_app_secret>"
        }
        response = requests.post(url, json=payload, headers=headers)
        access_token = response.json().get("tenant_access_token")
        return access_token

    def send_message(self, receive_id_type, receive_id, content=None, card_template_name=None, template_variables=None):
        access_token = self.get_access_token()

        if card_template_name:
            card_template = self.FEISHU_CARD_TEMPLATES.get(card_template_name)
            if not card_template:
                logger.warning(f"No card template found for name: {card_template_name}, using default message.")
                card_template_name = None
            else:
                if template_variables:
                    for key, value in template_variables.items():
                        card_template['template_variable'][key] = value
                
                card_content = {
                    "type": "template",
                    "data": {
                        "template_id": card_template["template_id"],
                        "template_variable": card_template["template_variable"]
                    }
                }
                payload_content = json.dumps(card_content)

        if not card_template_name:
            payload_content = json.dumps({
                "config": {
                    "wide_screen_mode": True
                },
                "elements": [
                    {
                        "tag": "div",
                        "text": {
                            "content": f"I received your message: {content}",
                            "tag": "lark_md"
                        }
                    }
                ]
            })

        url = f'https://open.feishu.cn/open-apis/im/v1/messages?receive_id_type={receive_id_type}'
        headers = {
            'Authorization': f'Bearer {access_token}',
            'Content-Type': 'application/json; charset=utf-8'
        }
        payload = {
            'receive_id': receive_id,
            'msg_type': 'interactive',
            'content': payload_content
        }

        response = requests.post(url, json=payload, headers=headers)
        print(f"Send Message Card response: {response.text}")
        return response.json()

    def update_message(self, message_id, content=None, card_template_name=None, template_variables=None):
        access_token = self.get_access_token()
        try:
            if card_template_name:
                card_template = self.FEISHU_CARD_TEMPLATES.get(card_template_name)
                if not card_template:
                    logger.warning(f"No card template found for name: {card_template_name}, using default message.")
                    card_template_name = None
                else:
                    if template_variables:
                        for key, value in template_variables.items():
                            card_template['template_variable'][key] = value
                    
                    card_content = {
                        "type": "template",
                        "data": {
                            "template_id": card_template["template_id"],
                            "template_variable": card_template["template_variable"]
                        }
                    }
                    payload_content = json.dumps(card_content)
        except Exception as e:
            logger.error(f"Error: missing key {e}") 

        if not card_template_name:
            payload_content = json.dumps({
                "config": {
                    "wide_screen_mode": True
                },
                "elements": [
                    {
                        "tag": "div",
                        "text": {
                            "content": f"This is my answer: {content}",
                            "tag": "lark_md"
                        }
                    }
                ]
            })

        url = f'https://open.feishu.cn/open-apis/im/v1/messages/{message_id}'
        headers = {
            'Authorization': f'Bearer {access_token}',
            'Content-Type': 'application/json; charset=utf-8'
        }
        payload = {
            'content': payload_content
        }
        response = requests.patch(url, json=payload, headers=headers)
        print(f"Update Message Card response: {response.text}")
        try:
            return response.json()
        except requests.exceptions.JSONDecodeError:
            print("Failed to decode JSON response")
            return response.text

# å®ä¾‹åŒ–FeishuAPIå¹¶å‘é€æ¶ˆæ¯
feishu_api = FeishuAPI()

message_response = feishu_api.send_message(
    receive_id_type='chat_id',
    receive_id='oc_1234567890',
    content='Hello, this is a test message.',
    card_template_name='example_template',
    template_variables={'username': 'Alice'}
)

# æ›´æ–°æ¶ˆæ¯
update_response = feishu_api.update_message(
    message_id='om_9876543210',
    content='This is the updated message content.',
    card_template_name='example_template',
    template_variables={'username': 'Bob'}
)
```
ä»¥ä¸Šæ˜¯å°è£…å¥½çš„é£ä¹¦æ¶ˆæ¯å¡ç‰‡APIçš„è¯¦ç»†ä½¿ç”¨è¯´æ˜ã€‚é€šè¿‡è¿™äº›æ–¹æ³•ï¼Œç”¨æˆ·å¯ä»¥æ–¹ä¾¿åœ°å‘é€å’Œæ›´æ–°é£ä¹¦æ¶ˆæ¯å¡ç‰‡ã€‚å¸Œæœ›è¿™äº›ä¿¡æ¯å¯¹ä½ æœ‰å¸®åŠ©ï¼